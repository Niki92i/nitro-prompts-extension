// Debug script for Nitro Prompts extension
// Add this to the browser console to test the extension

console.log('üîç Nitro Prompts Debug Script Loaded');

// Function to check extension status
function checkExtensionStatus() {
  console.log('=== Nitro Prompts Extension Status ===');
  
  // Check if module exists
  const module = document.getElementById('nitro-prompts-module');
  console.log('Module exists:', !!module);
  
  if (module) {
    console.log('Module display style:', module.style.display);
    console.log('Module classes:', module.className);
    console.log('Module opacity:', module.style.opacity);
  }
  
  // Check chrome API availability
  console.log('Chrome API available:', typeof chrome !== 'undefined');
  console.log('Chrome runtime available:', typeof chrome !== 'undefined' && !!chrome.runtime);
  
  // Try to get settings
  if (typeof chrome !== 'undefined' && chrome.storage) {
    chrome.storage.sync.get('nitroPromptsSettings', (result) => {
      console.log('Current settings:', result.nitroPromptsSettings);
    });
  }
  
  console.log('=====================================');
}

// Function to test toggle
function testToggle() {
  console.log('üîÑ Testing toggle...');
  
  if (typeof chrome !== 'undefined' && chrome.runtime) {
    chrome.runtime.sendMessage({action: 'toggleModule'}, (response) => {
      console.log('Toggle response:', response);
      setTimeout(checkExtensionStatus, 500);
    });
  } else {
    console.log('‚ùå Chrome API not available');
  }
}

// Function to test settings update
function testSettingsUpdate(enabled) {
  console.log(`‚öôÔ∏è Testing settings update (enabled: ${enabled})...`);
  
  if (typeof chrome !== 'undefined' && chrome.runtime) {
    chrome.runtime.sendMessage({
      action: 'updateSettings',
      settings: {
        enabled: enabled,
        intelligenceLevel: 'intermediate',
        transparency: 80,
        moduleSize: 'medium',
        position: { x: 20, y: 20 },
        customPrompts: []
      }
    }, (response) => {
      console.log('Settings update response:', response);
      setTimeout(checkExtensionStatus, 500);
    });
  } else {
    console.log('‚ùå Chrome API not available');
  }
}

// Function to manually show/hide module
function manualToggle() {
  const module = document.getElementById('nitro-prompts-module');
  if (module) {
    if (module.style.display === 'none') {
      module.style.display = 'block';
      module.classList.add('show');
      console.log('‚úÖ Module manually shown');
    } else {
      module.style.display = 'none';
      module.classList.remove('show');
      console.log('‚úÖ Module manually hidden');
    }
  } else {
    console.log('‚ùå Module not found');
  }
}

// Function to reset module state
function resetModuleState() {
  console.log('üîÑ Resetting module state...');
  
  if (typeof chrome !== 'undefined' && chrome.runtime) {
    chrome.runtime.sendMessage({
      action: 'updateSettings',
      settings: {
        enabled: false,
        intelligenceLevel: 'intermediate',
        transparency: 80,
        moduleSize: 'medium',
        position: { x: 20, y: 20 },
        customPrompts: []
      }
    }, (response) => {
      console.log('Reset response:', response);
      setTimeout(checkExtensionStatus, 500);
    });
  } else {
    console.log('‚ùå Chrome API not available');
  }
}

// Function to force sync popup state
function forceSyncPopup() {
  console.log('üîÑ Forcing popup state sync...');
  
  if (typeof chrome !== 'undefined' && chrome.runtime) {
    chrome.runtime.sendMessage({action: 'getModuleState'}, (response) => {
      console.log('Module state:', response);
      if (response && response.success) {
        console.log('Current module visible:', response.visible);
        console.log('To fix popup, set checkbox to:', response.visible);
      }
    });
  } else {
    console.log('‚ùå Chrome API not available');
  }
}

// Function to test transparency
function testTransparency(value) {
  console.log(`üé® Testing transparency: ${value}%`);
  
  if (typeof chrome !== 'undefined' && chrome.runtime) {
    chrome.runtime.sendMessage({
      action: 'updateTransparency',
      transparency: value
    }, (response) => {
      console.log('Transparency update response:', response);
      setTimeout(checkExtensionStatus, 500);
    });
  } else {
    console.log('‚ùå Chrome API not available');
  }
}

// Function to check current transparency
function checkTransparency() {
  const module = document.getElementById('nitro-prompts-module');
  if (module) {
    const opacity = parseFloat(module.style.opacity);
    const transparency = Math.round(opacity * 100);
    console.log(`üé® Current transparency: ${transparency}% (opacity: ${opacity})`);
    return transparency;
  } else {
    console.log('‚ùå Module not found');
    return null;
  }
}

// Function to test API key input
function testApiKeyInput() {
  console.log('üîë Testing API key input...');
  
  // Try to find the API key input in the popup
  if (typeof chrome !== 'undefined' && chrome.runtime) {
    chrome.runtime.sendMessage({action: 'getSettings'}, (response) => {
      if (response && response.geminiApiKey) {
        console.log('‚úÖ API key found in settings:', response.geminiApiKey.substring(0, 10) + '...');
      } else {
        console.log('‚ùå No API key found in settings');
      }
    });
  } else {
    console.log('‚ùå Chrome API not available');
  }
}

// Function to simulate API key paste
function simulateApiKeyPaste(apiKey) {
  console.log('üìã Simulating API key paste...');
  
  if (typeof chrome !== 'undefined' && chrome.runtime) {
    chrome.runtime.sendMessage({
      action: 'updateSettings',
      settings: {
        geminiApiKey: apiKey
      }
    }, (response) => {
      if (response && response.success) {
        console.log('‚úÖ API key saved successfully');
      } else {
        console.log('‚ùå Failed to save API key');
      }
    });
  } else {
    console.log('‚ùå Chrome API not available');
  }
}

// Function to test API key input field
function testApiKeyField() {
  console.log('üîë Testing API key input field...');
  
  // Check if the popup is open and has the API key field
  if (typeof chrome !== 'undefined' && chrome.runtime) {
    chrome.runtime.sendMessage({action: 'getSettings'}, (response) => {
      if (response && response.geminiApiKey) {
        console.log('‚úÖ API key found in settings:', response.geminiApiKey.substring(0, 10) + '...');
        console.log('üìù API key length:', response.geminiApiKey.length);
      } else {
        console.log('‚ùå No API key found in settings');
      }
    });
  } else {
    console.log('‚ùå Chrome API not available');
  }
  
  // Try to find the input field in the current page (if popup is open)
  const apiKeyField = document.getElementById('geminiApiKey');
  if (apiKeyField) {
    console.log('‚úÖ API key field found in DOM');
    console.log('üìù Field type:', apiKeyField.type);
    console.log('üìù Field value length:', apiKeyField.value.length);
    console.log('üìù Field placeholder:', apiKeyField.placeholder);
    console.log('üìù Field is focused:', document.activeElement === apiKeyField);
  } else {
    console.log('‚ùå API key field not found in DOM');
  }
}

// Function to simulate typing in API key field
function simulateApiKeyTyping(text) {
  console.log('‚å®Ô∏è Simulating typing in API key field...');
  
  const apiKeyField = document.getElementById('geminiApiKey');
  if (apiKeyField) {
    apiKeyField.focus();
    apiKeyField.value = text;
    apiKeyField.dispatchEvent(new Event('input', { bubbles: true }));
    console.log('‚úÖ Simulated typing:', text.substring(0, 10) + '...');
  } else {
    console.log('‚ùå API key field not found');
  }
}

// Function to test paste functionality
function simulateApiKeyPasteField(text) {
  console.log('üìã Simulating paste in API key field...');
  
  const apiKeyField = document.getElementById('geminiApiKey');
  if (apiKeyField) {
    apiKeyField.focus();
    
    // Create a paste event
    const pasteEvent = new ClipboardEvent('paste', {
      bubbles: true,
      cancelable: true,
      clipboardData: new DataTransfer()
    });
    
    // Simulate the paste
    apiKeyField.dispatchEvent(pasteEvent);
    
    // Set the value after paste
    setTimeout(() => {
      apiKeyField.value = text;
      apiKeyField.dispatchEvent(new Event('input', { bubbles: true }));
      console.log('‚úÖ Simulated paste:', text.substring(0, 10) + '...');
    }, 10);
  } else {
    console.log('‚ùå API key field not found');
  }
}

// Function to test clipboard API paste
async function testClipboardPaste() {
  console.log('üìã Testing clipboard API paste...');
  
  try {
    const text = await navigator.clipboard.readText();
    if (text) {
      console.log('‚úÖ Clipboard content:', text.substring(0, 20) + '...');
      
      const apiKeyField = document.getElementById('geminiApiKey');
      if (apiKeyField) {
        apiKeyField.value = text;
        apiKeyField.dispatchEvent(new Event('input', { bubbles: true }));
        console.log('‚úÖ Pasted via clipboard API');
        return true;
      } else {
        console.log('‚ùå API key field not found');
        return false;
      }
    } else {
      console.log('‚ùå Clipboard is empty');
      return false;
    }
  } catch (error) {
    console.error('‚ùå Clipboard API failed:', error);
    return false;
  }
}

// Function to test all paste methods
async function testAllPasteMethods() {
  console.log('üß™ Testing all paste methods...');
  
  const testKey = 'test-api-key-12345';
  
  // Test 1: Direct value assignment
  console.log('1. Testing direct value assignment...');
  const apiKeyField = document.getElementById('geminiApiKey');
  if (apiKeyField) {
    apiKeyField.value = testKey;
    apiKeyField.dispatchEvent(new Event('input', { bubbles: true }));
    console.log('‚úÖ Direct assignment successful');
  }
  
  // Test 2: Simulate paste event
  console.log('2. Testing paste event simulation...');
  simulateApiKeyPasteField(testKey);
  
  // Test 3: Test clipboard API
  console.log('3. Testing clipboard API...');
  await testClipboardPaste();
  
  // Test 4: Test keyboard shortcut
  console.log('4. Testing keyboard shortcut...');
  if (apiKeyField) {
    apiKeyField.focus();
    const keyEvent = new KeyboardEvent('keydown', {
      key: 'v',
      ctrlKey: true,
      bubbles: true
    });
    apiKeyField.dispatchEvent(keyEvent);
  }
  
  console.log('üß™ All paste method tests completed');
}

// Auto-run status check
setTimeout(checkExtensionStatus, 1000);

// Make functions available globally
window.nitroDebug = {
  checkStatus: checkExtensionStatus,
  testToggle: testToggle,
  testSettingsUpdate: testSettingsUpdate,
  manualToggle: manualToggle,
  resetModuleState: resetModuleState,
  forceSyncPopup: forceSyncPopup,
  testTransparency: testTransparency,
  checkTransparency: checkTransparency,
  testApiKeyInput: testApiKeyInput,
  simulateApiKeyPaste: simulateApiKeyPaste,
  testApiKeyField: testApiKeyField,
  simulateApiKeyTyping: simulateApiKeyTyping,
  simulateApiKeyPasteField: simulateApiKeyPasteField,
  testClipboardPaste: testClipboardPaste,
  testAllPasteMethods: testAllPasteMethods
};

console.log('üí° Use nitroDebug.checkStatus() to check extension status');
console.log('üí° Use nitroDebug.testToggle() to test toggle functionality');
console.log('üí° Use nitroDebug.testSettingsUpdate(true/false) to test settings');
console.log('üí° Use nitroDebug.manualToggle() to manually toggle module');
console.log('üí° Use nitroDebug.resetModuleState() to reset module to disabled state');
console.log('üí° Use nitroDebug.forceSyncPopup() to check current module state');
console.log('üí° Use nitroDebug.testTransparency(50) to test transparency (0-100)');
console.log('üí° Use nitroDebug.checkTransparency() to check current transparency');
console.log('üí° Use nitroDebug.testApiKeyInput() to test API key input');
console.log('üí° Use nitroDebug.simulateApiKeyPaste("your-api-key") to set API key');
console.log('üí° Use nitroDebug.testApiKeyField() to test API key field');
console.log('üí° Use nitroDebug.simulateApiKeyTyping("text") to simulate typing');
console.log('üí° Use nitroDebug.simulateApiKeyPasteField("text") to simulate paste');
console.log('üí° Use nitroDebug.testClipboardPaste() to test clipboard API');
console.log('üí° Use nitroDebug.testAllPasteMethods() to test all paste methods'); 

// Debug function to test toggle functionality
function debugToggle() {
  console.log('üîß === TOGGLE DEBUG START ===');
  
  // Test 1: Check popup state
  console.log('üìã Testing popup state...');
  const enableModule = document.getElementById('enableModule');
  if (enableModule) {
    console.log('‚úÖ Enable module checkbox found');
    console.log('üìä Checkbox checked state:', enableModule.checked);
  } else {
    console.log('‚ùå Enable module checkbox not found');
  }
  
  // Test 2: Check storage
  console.log('üíæ Testing storage...');
  chrome.storage.sync.get('nitroPromptsSettings', (result) => {
    console.log('üìä Storage result:', result);
    const settings = result.nitroPromptsSettings;
    if (settings) {
      console.log('‚úÖ Settings found in storage');
      console.log('üìä Enabled state in storage:', settings.enabled);
    } else {
      console.log('‚ùå No settings found in storage');
    }
  });
  
  // Test 3: Check content script communication
  console.log('üîÑ Testing content script communication...');
  chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
    if (tabs[0] && tabs[0].url && tabs[0].url.startsWith('http')) {
      console.log('‚úÖ Valid tab found:', tabs[0].url);
      
      // Test getModuleState
      chrome.tabs.sendMessage(tabs[0].id, { action: 'getModuleState' }, (response) => {
        if (chrome.runtime.lastError) {
          console.log('‚ùå Content script communication error:', chrome.runtime.lastError.message);
        } else if (response) {
          console.log('‚úÖ Content script responded');
          console.log('üìä Module state:', response);
        } else {
          console.log('‚ùå No response from content script');
        }
      });
      
      // Test ping
      chrome.tabs.sendMessage(tabs[0].id, { action: 'ping' }, (response) => {
        if (chrome.runtime.lastError) {
          console.log('‚ùå Ping failed:', chrome.runtime.lastError.message);
        } else if (response) {
          console.log('‚úÖ Ping successful:', response);
        } else {
          console.log('‚ùå No ping response');
        }
      });
    } else {
      console.log('‚ùå No valid tab found');
    }
  });
  
  console.log('üîß === TOGGLE DEBUG END ===');
}

// Add debug toggle function to global scope
window.debugToggle = debugToggle; 

// Function to force re-enable the module
function forceEnableModule() {
  console.log('üîß === FORCE ENABLE MODULE ===');
  
  // Step 1: Force update settings to enabled
  console.log('üìù Step 1: Updating settings to enabled...');
  chrome.storage.sync.set({
    nitroPromptsSettings: {
      enabled: true,
      intelligenceLevel: 'intermediate',
      transparency: 80,
      moduleSize: 'medium',
      position: { x: 20, y: 20 },
      customPrompts: [],
      geminiApiKey: ''
    }
  }, () => {
    console.log('‚úÖ Settings updated to enabled');
    
    // Step 2: Send message to content script
    console.log('üîÑ Step 2: Sending enable message to content script...');
    chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
      if (tabs[0] && tabs[0].url && tabs[0].url.startsWith('http')) {
        chrome.tabs.sendMessage(tabs[0].id, { action: 'showModule' }, (response) => {
          if (chrome.runtime.lastError) {
            console.log('‚ùå Content script error:', chrome.runtime.lastError.message);
          } else if (response) {
            console.log('‚úÖ Content script responded:', response);
          } else {
            console.log('‚ùå No response from content script');
          }
          
          // Step 3: Verify the change
          setTimeout(() => {
            console.log('üîç Step 3: Verifying module state...');
            chrome.tabs.sendMessage(tabs[0].id, { action: 'getModuleState' }, (stateResponse) => {
              if (stateResponse && stateResponse.success) {
                console.log('üìä Final module state:', stateResponse);
                if (stateResponse.visible) {
                  console.log('‚úÖ Module successfully enabled!');
                } else {
                  console.log('‚ùå Module still not visible');
                }
              } else {
                console.log('‚ùå Could not verify module state');
              }
            });
          }, 500);
        });
      } else {
        console.log('‚ùå No valid tab found');
      }
    });
  });
}

// Function to completely reset and reinitialize
function resetAndReinitialize() {
  console.log('üîÑ === RESET AND REINITIALIZE ===');
  
  // Step 1: Clear all settings
  console.log('üóëÔ∏è Step 1: Clearing all settings...');
  chrome.storage.sync.clear(() => {
    console.log('‚úÖ Settings cleared');
    
    // Step 2: Reload the page to reinitialize
    console.log('üîÑ Step 2: Reloading page...');
    chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
      if (tabs[0]) {
        chrome.tabs.reload(tabs[0].id, () => {
          console.log('‚úÖ Page reloaded');
          
          // Step 3: Wait and then enable
          setTimeout(() => {
            console.log('‚è≥ Step 3: Waiting for page to load...');
            setTimeout(() => {
              console.log('üëÅÔ∏è Step 4: Enabling module...');
              forceEnableModule();
            }, 2000);
          }, 1000);
        });
      }
    });
  });
}

// Add new functions to global scope
window.forceEnableModule = forceEnableModule;
window.resetAndReinitialize = resetAndReinitialize;

// Add to nitroDebug object
window.nitroDebug.forceEnable = forceEnableModule;
window.nitroDebug.resetAndReinit = resetAndReinitialize;

console.log('üí° Use forceEnableModule() to force enable the module');
console.log('üí° Use resetAndReinitialize() to completely reset and reinitialize');
console.log('üí° Use nitroDebug.forceEnable() to force enable the module');
console.log('üí° Use nitroDebug.resetAndReinit() to completely reset and reinitialize'); 